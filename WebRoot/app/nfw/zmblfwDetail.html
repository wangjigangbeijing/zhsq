
		<script src="./nfw/zmblfwDetail.js"></script>
		<script src="./device.js"></script>
		<script type="text/javascript" src="./qwebchannel.js"></script>
		
		<section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>添加证明打印事项</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">列表</a></li>
              <li class="breadcrumb-item active">新增</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    

    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
			 <div class="card">
              <div class="card card-info">
              <form class="form-horizontal">
                <div class="card-body">
					
					<div class="form-group">
                      <label>办理人&nbsp;&nbsp;<button class="btn btn-primary" type="button" data-toggle="modal" data-target="#residentDialog" onclick="searchResident(); return false;">选择</button><button class="btn btn-info" type="button" onclick="startidcard(); return false;" style="margin-left:15px;">身份证读取</button></label>
                      <input type="hidden" class="form-control" id="blr">
					  <input type="text" class="form-control" id="blrname">
                    </div>
					
						<div class="form-group">
                      <label>联系电话</label>
                      <input type="" class="form-control" id="lxdh" placeholder="">
                    </div>

                    <div class="form-group">
                      <label>办理渠道</label>
                      <select class="form-control" id="blqd">
                        <option>办事大厅</option>
                        <option>社区热线</option>
                        <option>微信平台</option>
                        <option>智能办事终端</option>
                        <option>其他</option>
                      </select>
                    </div>

                    <div class="form-group">
                      <label>证明事项大类</label>
                      <select class="form-control" id="zmsxdl">
                        <option value="民政">民政</option>
                      </select>
                    </div>
					
				<div class="form-group">
                      <label>证明事项小类</label>
                      <select class="form-control" id="zmsxxl">
                        <option value="居住证">居住证</option>
                      </select>
                    </div>
					
					<div class="form-group">
                      <label>办理时间</label>
					  <input type="text" class="form-control" id="blsj" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})">
						
                    </div>

             

                       <div class="form-group">
                          <label>详情</label>
                          <textarea class="form-control" rows="3" placeholder="" id="xq"></textarea>
                        </div>

                        <div class="form-group">
                          <label>备注</label>
                          <textarea class="form-control" rows="3" placeholder="" id="bz"></textarea>
                        </div>

                  <div class='form-group row'>
						<label class='col-md-1 control-label'>附件</label>
						<div class='col-md-11'>
						<div id='picturesdiv' class='wu-example'>
						<input type='text' class='form-control field' name='pictures' id='pictures' style='display:none;'>
						<table class='table' id='picturespicktable'><thead><tr><th>名称</th><th>状态</th><th>操作</th></tr></thead><tbody></tbody></table>
						<div class='row'>
						<div id='picturespick' class="col-sm-1">选择文件</div>
						
						<div style="col-sm-1">
						<button class="btn btn-success" type="button" data-toggle="modal" data-target="#deviceDialog" onclick="startdevice();" style="height:35px; font-size:14px;" >高拍仪</button>
						</div>
						</div>
						</div>
 						</div>
 					</div>
					
                </div>
                <div class="card-footer">
				
				 <button class="btn btn-info" type="button" onclick="addOrUpdate();">确定</button>
                  <button class="btn btn-default float-right" type="button" onclick="gobackPage();">取消</button>
				  
                </div>
              </form>
            </div>
			  
          </div>
        </div>
      </div>
	  
	  <div class="modal fade" id="deviceDialog">
        <div class="modal-dialog">
          <div class="modal-content" style="width:1000px;">
            <div class="modal-header">
              <h4 class="modal-title">材料拍照</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              
			  <form class="form-horizontal">
                <!--div class="card-body"-->
				  <div class='form-group row'>
                  <img class='col-md-8' id="bigPriDev" width="640" height="480"  /></img>
				
				  <img class='col-md-4' id="devPhoto" width="360" height="270"  /></img>
				  </div>
				  <!--
				  <textarea id="output"></textarea><br />	
				  -->
              </form>
			 </div> 
			 
			 <div class="modal-footer justify-content-between">
              <button type="button" id="photographPri" class="btn btn-primary" onclick="doPhoto1(); return false;">拍照</button>
              <button type="button" class="btn btn-default" data-dismiss="modal" >关闭</button>
            </div>
			  
            </div>
            
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
	  
	  <div class="modal fade" id="residentDialog">
        <div class="modal-dialog">
          <div class="modal-content" style="width:1000px;">
            <div class="modal-header">
              <h4 class="modal-title">居民选择</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              
			  <form class="form-horizontal">
                <!--div class="card-body"-->
                  <div class="form-group row">
                    <label for="inputEmail3" class="col-sm-1 col-form-label">姓名</label>
                    <div class="col-sm-2">
                      <input class="form-control" id="residentNameQry">
                    </div>
					
					
					 <label for="inputEmail3" class="col-sm-1 col-form-label">居民类别</label>
                    <div class="col-sm-4">
                      
					  <select id="characterQry" class="select2" style="width: 100%;">
					    <option value=''></option>
						<option value='中共党员'>中共党员</option>
						<option value='志愿者'>志愿者</option>
						<option value='居民代表'>居民代表</option>
						<option value='楼门长'>楼门长</option>
						<option value='军人'>军人</option>
						<option value='文体骨干'>文体骨干</option>
						<option value='优抚对象'>优抚对象</option>
						<option value='少数民族'>少数民族</option>
						<option value='0-6岁儿童'>0-6岁儿童</option>
						<option value='7-13岁青少年'>7-13岁青少年</option>
						<option value='13-18岁青少年'>13-18岁青少年</option>
						<option value='老年人'>老年人</option>
						<option value='80岁以上老人'>80岁以上老人</option>
						<option value='90岁以上老人'>90岁以上老人</option>
						<option value='独居老人'>独居老人</option>
						<option value='失独老人'>失独老人</option>
						<option value='空巢老人'>空巢老人</option>
						<option value='失业人员'>失业人员</option>
						<option value='待业人员'>待业人员</option>
						<option value='精神病人'>精神病人</option>
						<option value='残疾人'>残疾人</option>
						<option value='重点人员'>重点人员</option>
						<option value='两劳释放'>两劳释放</option>
						<option value='在押在教'>在押在教</option>
						<option value='社区矫正人员'>社区矫正人员</option>
						</select>
                    </div>
					
					<button id="btnSearch" type="button" class="btn btn-info" onclick="searchResident();">查询</button>
					
                  </div>
              </form>
			  
			  <div class="card-body">
                <table class="table table-bordered table-striped" id="dataTable">
                  <thead>
                  <tr>
					<th style='text-align:center;'><input type="checkbox" class="checkall"/></th>
                    <th style='text-align:center;'>姓名</th>
					<th style='text-align:center;'>居民特征</th>
					<th style='text-align:center;'>手机号</th>
					<th style='text-align:center;'>居住地</th>
                  </tr>
                  </thead>
				  <tbody></tbody>
                </table>
              </div>
			  
			  
            </div>
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" onclick="javascript:addAllUser();">添加选中</button>
              <button type="button" data-dismiss="modal" class="btn btn-primary">关闭</button>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
	  
    </section>
		
	<script>
		var header = getContextPath()+"/fileController/download?fileName=";
		
		var uploaderpictures = WebUploader.create({
			auto: true,
		// swf文件路径
		//swf: BASE_URL + '/js/Uploader.swf',
		// 文件接收服务端
		server: getContextPath()+'/fileController/upload',
		// 选择文件的按钮。可选。
		// 内部根据当前运行是创建，可能是input元素，也可能是flash.
		pick: '#picturespick',
		formData:{
		attributeName:'pictures'
		}
		});
		uploaderpictures.on( 'fileQueued', function( file ) {
			$('#'+file.source._refer[0].id+'table').append('<tr><td id=name_' + file.id + '>'+file.name+'</td><td id='+file.id+'>等待上传...</td>'+
								"<td><button type='button' id='"+file.id+"Button' class='btn btn-success btn-xs' onclick='javascript:downloadAttach();return false;'><i class='fa fa-check'></i></button></td>"+
								'</tr>');
		});
		uploaderpictures.on( 'uploadSuccess', function( file,response ) {
			var url = header + response.fileName;
			if(response.fileName.indexOf(".pdf") >= 0 || response.fileName.indexOf(".PDF") >= 0){
				var uurl = getContextPath() + "/dist/js/pdf.html?param=" + url;
				var content = '<a href="' + uurl + '" target="_blank">'+response.fileName+'</a>';
				$("#name_" + file.id).html(content);
			}
			else {
				var content = '<a href="' + url + '" data-lightbox="' + response.fileName + '" data-title="' + response.fileName + '" style="color:#64A600; font-size: 12px;">'+response.fileName+'</a>';
				$("#name_" + file.id).html(content);
			}
			
			$( '#'+response.attributeName ).val(response.fileName+VALUE_SPLITTER+$('#'+response.attributeName ).val());
			console.log($( '#'+response.attributeName ).val());
			$( '#'+file.id ).text('已上传');
			$('#'+file.id+'Button').attr('onclick', onclick='javascript:downloadAttach("'+response.fileName+'");return false;');
		});
		uploaderpictures.on( 'uploadError', function( file,response ) {
		});	
	</script>
	
	<script>
		var dataGridTable;
	
		var userList = null;
		
		var  lTotalCnt = 0;

		function searchResident()
		{
			var residentName = $('#residentNameQry').val();
			var characteristics = $('#characterQry').val();			
			
			lTotalCnt = 0;
			
			if(dataGridTable!=null){  
				dataGridTable.fnClearTable(0);  
			}
			
			dataGridTable = $("#dataTable").dataTable({	
				destroy: true,
				stateSave: false,
				iDisplayLength: 10,
				lengthChange: false,
				"paging": true,
				"lengthChange": false,
				"searching": false,
				"bProcessing" : true,  
				"aaSorting": [[ 0, "asc" ]],  
				"ordering": true,
				"info": true,
				"oLanguage": { 
							"sProcessing": "正在加载中......", 
							"sLengthMenu": "每页显示 _MENU_ 条记录", 
							"sZeroRecords": "对不起，查询不到相关数据！", 
							"sInfoEmpty":"",
							"sInfo": "当前显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录", 
							"sInfoFiltered": "数据表中共为 _MAX_ 条记录", 
							"sSearch": "搜索", 
							"oPaginate":  
							{ 
								"sFirst": "首页", 
								"sPrevious": "上一页", 
								"sNext": "下一页", 
								"sLast": "末页" 
							}
						}, //多语言配置					
				"autoWidth": false,
				"bServerSide" : true,
				"sAjaxSource" : getContextPath()+'/residentController/load',
				"fnServerParams" : function(aoData) {  
					aoData.push({  
						"name" : "statId",  
						"value" : "abc"
					});  
				},  
				"columns": [
							{
								"sClass": "text-center",
								"data": "id",
								"render": function (data, type, row, meta) {
									return '<input type="checkbox" name="resid" value="' + data + '"/>';
								},
							},
							{ 'data': 'name' ,'sClass':'text-center',
								mRender : function(data,type,full){
									return showData(aesDecrypt(full.name), 1);
								}
							},
							{ 'data': 'characteristics' ,'sClass':'text-center'},
							{ 'data': 'mobile' ,'sClass':'text-center',
								mRender : function(data,type,full){
									return showData(aesDecrypt(full.mobile), 2);
								}
							},
							{ 'data': 'address' ,'sClass':'text-center'}
						],
				columnDefs: [],
				"fnServerData" : function(sSource, aoData, fnCallback) {  
					$('#btnSearch').attr('disabled','disabled');
					
					$.ajax({
						"type" : 'get',  
						"url" : sSource,  
						"dataType" : "json",  
						"data" : {  
							aoData : JSON.stringify(aoData),
							totalCnt : lTotalCnt,
							name : residentName,
							characteristics : characteristics
						},
						"success" : function(resp) {
							$('#btnSearch').removeAttr('disabled');
							
							if(resp.success == true)
							{
								userList = resp.list;
							
								fnCallback(resp);
							
								lTotalCnt = resp.iTotalRecords;
							}
							else
							{
								jError("加载数据出错!",{
									VerticalPosition : 'center',
									HorizontalPosition : 'center'
								});
							}
						},
						"failure":function (result) {
							$('#btnSearch').removeAttr('disabled');
						}
					});  
				}
			});
		}
		
		function addAllUser()
		{
			//$('input:checkbox:checked') 等同于 $('input[type=checkbox]:checked')
			//意思是选择被选中的checkbox
			var users = '', phones = '';
			var ids = '';
			$('input:checkbox[name=resid]:checked').each(function (i) {
				var val = $(this).val();
				for(var i=0;i<userList.length;i++)
				{
					if(userList[i].id == val){
						var name = '', phone = '';
						if(typeof(userList[i].name)!="undefined") name = showData(aesDecrypt(userList[i].name), 1);
						if(typeof(userList[i].mobile)!="undefined") phone = showData(aesDecrypt(userList[i].mobile), 2);
						if(users == '') users = name;
						else users += ", " + name;
						if(phones == '') phones = phone;
						else phones += ", " + phone;
						
						if(ids == '') ids = val;
						else ids += ", " + val;
					}
				}
				
			});
			
			$('#blrname').val(users);
			$('#blr').val(ids);
			$('#lxdh').val(phones);
		}
		
		$(document).ready(function (){
			//使用live绑定数据，因为checkAll还没有加载好
			$(".checkall").on("click", function () {
				if (this.checked) {
					$(this).attr('checked', 'checked')
					$("input[name='resid']").each(function () {
						this.checked = true;
					});

				   
				} else {
					$(this).removeAttr('checked')
					$("input[name='resid']").each(function () {
						this.checked = false;
					   
					});
				}
			});
			
		});
		
		function startdevice(){
			openSocket();
		}
		
		function startidcard(){
			openSocket();
			
			doIdCard();
		}
		
		//查询居民信息
		function queryresident(name, idnumber){
			if(hasuse){
				return;
			}
			else {
				hasuse = true;
			}
			$.get(getContextPath()+"/idcardController/queryresident?idnumber="+idnumber,
				function(result){
					var obj = jQuery.parseJSON(result);  
					if(obj.success)
					{
						var val = $('#blr').val();
						if(val == ''){
							$('#blr').val(obj.data.id);
						}
						else {
							$('#blr').val(val + "," + obj.data.id);
						}
						
						val = $('#blrname').val();
						if(val == ''){
							$('#blrname').val(showData(aesDecrypt(obj.data.name), 1));	
						}
						else {
							$('#blrname').val(val + "," + showData(aesDecrypt(obj.data.name), 1));
						}
						
						val = $("#lxdh").val();
						if(val == ''){
							$('#lxdh').val(showData(aesDecrypt(obj.data.mobile), 2));
						}
						else {
							$('#lxdh').val(val + "," + showData(aesDecrypt(obj.data.mobile), 2));
						}
					}
					else {
						var val = $('#blrname').val();
						if(val == ''){
							$('#blrname').val(showData(name, 1));	
						}
						else {
							$('#blrname').val(val + "," + showData(name, 1));
						}
					}
				});
		}
		
		</script>