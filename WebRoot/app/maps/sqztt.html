
<!--script src="../plugins/ol5/ol.js">

<script type="text/javascript" src="./maps/include-web.js"></script>
<script type="text/javascript" src="../plugins/iclient/ol/include-ol.js"></script-->

	
	
	

    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>社区专题图</h1>
          </div>
           <div class="col-sm-6 pull-right">
				<form class="form-horizontal">
				
				<div class='form-group row pull-right' id="layerDiv">
				
				</div>
				</form>
				
			  </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
        <section class="content">
      <div class="container-fluid">
        <!-- Info boxes -->
        <div class="row">
          <div class="col-12 col-sm-3 col-md-2">
            <div class="info-box">
              <span class="info-box-icon bg-success elevation-1"><i class="fas fa-flag"></i></span>

              <div class="info-box-content">                
				<span class="info-box-text"><a href="#" id="xfdjtAnchor">先锋党建图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>

          <div class="col-12 col-sm-3 col-md-2">
            <div class="info-box">
              <span class="info-box-icon bg-info elevation-1"><i class="fas fa-shopping-cart"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="sqfftAnchor">社区服务图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
          <div class="col-12 col-sm-6 col-md-2">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-plus-square"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="pajstAnchor">平安建设图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->

          <!-- fix for small devices only -->
          <div class="clearfix hidden-md-up"></div>

          <div class="col-12 col-sm-6 col-md-2">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-success elevation-1"><i class="fas fa-compass"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="wjtytAnchor">文教体育图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>

          <div class="col-12 col-sm-6 col-md-2">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-success elevation-1"><i class="fas fa-trash"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="hjwstAnchor">环境卫生图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>

          <!-- /.col -->
          <div class="col-12 col-sm-6 col-md-2">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-exclamation-triangle"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="fzbxtAnchor">防灾避险图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>

          <!-- /.col -->
        </div>

        <div class="row">
          <div class="col-12 col-sm-3 col-md-2">
            <div class="info-box">
              <span class="info-box-icon bg-success elevation-1"><i class="fas fa-user"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="zdryAnchor">重点人员图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>

          <div class="col-12 col-sm-3 col-md-2">
            <div class="info-box">
              <span class="info-box-icon bg-info elevation-1"><i class="fas fa-circle"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="hzhztAnchor">河长湖长图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->
          <div class="col-12 col-sm-6 col-md-2">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-road"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="jzxztAnchor">街长巷长图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>
          <!-- /.col -->

          <!-- fix for small devices only -->
          <div class="clearfix hidden-md-up"></div>

          <div class="col-12 col-sm-6 col-md-2">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-success elevation-1"><i class="fas fa-envelope"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="xczdtAnchor">宣传阵地图</a></span>
                <span class="info-box-text"></span>
                <span class="info-box-number"></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>

    

          <!-- /.col -->
          <div class="col-12 col-sm-6 col-md-2">
            <div class="info-box mb-3">
              <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-map-signs"></i></span>

              <div class="info-box-content">
				<span class="info-box-text"><a href="#" id="csgltAnchor">城市管理图</a></span>
              </div>
              <!-- /.info-box-content -->
            </div>
            <!-- /.info-box -->
          </div>

          <!-- /.col -->
        </div>
        <!-- /.row -->
      </div><!--/. container-fluid -->
    </section>
	
	
	  <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-12">
            <!-- AREA CHART -->
            <div class="card card-primary">
              <div class="card-header">
                <h3 class="card-title" id="mapTitle">先锋党建图</h3>

                <div class="card-tools">
                  <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                  </button>
                  <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                </div>
              </div>
         	 <div class="card-body" id="sqzttDiv" style="height:700px;">
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->

  

          </div>
     
          <!-- /.col (RIGHT) -->
        </div>
        <!-- /.row -->
      </div><!-- /.container-fluid -->
    </section>

<!-- ChartJS>
<script src="./plugins/chart.js/Chart.min.js"></script -->


<style>
      .map {
        width: 100%;
        height:400px;
      }
      .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "✖";
      }
    </style>
	
	
<!-- ChartJS>
<script src="./plugins/chart.js/Chart.min.js"></script -->

<div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>

<!-- page script -->
<script>

var curMap = '';
var baseLayer = null;
var dataLayer = null;

function loadMap(mapName)
{
	curMap = 'mapName';
	
	dataLayer.getSource().clear();
	
	$.get(getContextPath()+"/gismapController/getMapByName?name="+mapName,
			function(response)
			{	
				var respObj = jQuery.parseJSON(response); 

				var geoServerURL = respObj.mapurl;
				
				for(var i=0;i<respObj.list.length;i++)
				{
					var layer = respObj.list[i];
					
					var layerName = layer.layersource;
					
					var layerId = layer.id;
					
					//图层列表
					var layerCtl = '<div class="form-check">' + 
                          '<input class="form-check-input" type="checkbox" name="layer" id="'+layerId+'" checked>' + 
                          '<label class="form-check-label">'+layer.note+'</label>' + 
                        '</div>';
					
					$('#layerDiv').append(layerCtl);
					
					var layerType = layer.layertype;
					
					var layerStyle = layer.layerstyle;
					
					$.ajax({
						type: "GET",
						url: getContextPath()+"/dataController/webwfs?layerId="+layerId,
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function (dataList) {
							
							for(var p=0;p < dataList.features.length;p++)
							{
								var data = dataList.features[p];
								
								console.log(data.type);
								if(data.type == 'MultiLineString')
								{
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.MultiLineString(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'Point')
								{
									var iconFeature = new ol.Feature({
										//geometry: new ol.geom.Point(ol.proj.transform(data.coordinates, 'EPSG:4326', 'EPSG:3857')),			
										geometry: new ol.geom.Point(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'MultiPolygon')
								{
									var pointArr = data.coordinates;
									
									var transferedArr = [];//data.coordinates;
									
									for(var q=0;q<pointArr.length;q++)
									{
										transferedArr[q] = ol.proj.transform(pointArr[q], 'EPSG:4326', 'EPSG:3857');
									}
									
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.Polygon(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									iconFeature.setId(data.info);
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
							}
						}
					});
				}
				
				
				
				
				$("input[name='layer']").change(function() {
					
					var checkedLayerId = '';
					
					$("input[name='layer']").each(function () {
						
						if($(this).prop('checked'))
							checkedLayerId += $(this).attr('id')+',';
					});
					
					
					$.ajax({
						type: "GET",
						//url:"http://49.233.26.198:8082/gis/zhsq/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=zhsq:jc_community&maxFeatures=50&outputFormat=application/json",
						url: getContextPath()+"/dataController/wfs?layerIds="+checkedLayerId,
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function (dataList) {
							
							dataLayer.getSource().clear();
							
							for(var p=0;dataList.features != null && p < dataList.features.length;p++)
							{
								var data = dataList.features[p];
								
								if(data.type == 'MultiLineString')
								{
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.MultiLineString(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'Point')
								{
									var iconFeature = new ol.Feature({
										geometry: data.coordinates,			
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'MultiPolygon')
								{
									var pointArr = data.coordinates;
									
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.Polygon(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									iconFeature.setId(data.info);
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
							}
						}
					});
					
				});
				
			}
	);
}
$(function () 
{
	$('#csgltAnchor').click(function () {
        loadMap('城市管理图');
    });
	
	$('#xczdtAnchor').click(function () {
        loadMap('宣传阵地图');
    });
	
	$('#jzxztAnchor').click(function () {
        loadMap('街长巷长图');
    });
	
	$('#hzhztAnchor').click(function () {
        loadMap('河长湖长图');
    });
	
	$('#zdryAnchor').click(function () {
        loadMap('重点人员图');
    });
	
	$('#fzbxtAnchor').click(function () {
        loadMap('防灾避险图');
    });
	
	$('#hjwstAnchor').click(function () {
        loadMap('环境卫生图');
    });
	
	$('#wjtytAnchor').click(function () {
        loadMap('文教体育图');
    });
	
	$('#pajstAnchor').click(function () {
        loadMap('平安建设图');
    });
	
	$('#sqfftAnchor').click(function () {
        loadMap('社区服务图');
    });
	
	$('#xfdjtAnchor').click(function () {
        loadMap('先锋党建图');
    });
	
	var container = document.getElementById('popup');
	var content = document.getElementById('popup-content');
	var closer = document.getElementById('popup-closer');

	/**
	 * Add a click handler to hide the popup.
	 * @return {boolean} Don't follow the href.
	 */
	closer.onclick = function() {
	  overlay.setPosition(undefined);
	  closer.blur();
	  return false;
	};


	/**
	 * Create an overlay to anchor the popup to the map.
	 */
	var overlay = new ol.Overlay({
	  element: container,
	  autoPan: true,
	  autoPanAnimation: {
		duration: 250
	  }
	});
	
	var map = new ol.Map({
		overlays: [overlay],
        target: 'sqzttDiv',
        view: new ol.View({
			//center: ol.proj.transform([116.30454,39.849639], 'EPSG:4326', 'EPSG:3857'),
			center: [116.30446673697033,39.883412379248995],
            zoom: 12,
			//projection: 'EPSG:3857',// 
			projection: 'EPSG:4326',// 
            multiWorld: true
        })/*,
        overlays: [overlay]*/
    });
    
	var baseLayer = new ol.layer.Tile({
        source: new ol.source.TileSuperMapRest({
            //url: "http://219.143.76.46:8089/iserver/services/map-agscache-fengtai/rest/maps/fengtai"
			url: "http://219.143.76.46:8089/iserver/services/map-tianditu/rest/maps/矢量底图_经纬度"
        })
    });
    map.addLayer(baseLayer);
	
	var baseLabelLayer = new ol.layer.Tile({
        source: new ol.source.TileSuperMapRest({
            //url: "http://219.143.76.46:8089/iserver/services/map-agscache-fengtai/rest/maps/fengtai"
			url: "http://219.143.76.46:8089/iserver/services/map-tianditu/rest/maps/矢量中文注记_经纬度"
        })
    });
    map.addLayer(baseLabelLayer);
	
	var dataSource = new ol.source.Vector();								
	dataLayer = new ol.layer.Vector({
		source: dataSource/*,
		style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'red',
                    width: 3
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.1)'
                })
            })*/
	});
	
	map.addLayer(dataLayer);
	
	map.on('singleclick', function(evt) 
	{
		var feature = map.forEachFeatureAtPixel(evt.pixel,
			function(feature) {
			
				return feature;
		});
		
		if(feature != null && feature != undefined)
		{
			var gid = feature.getId();
			
			//curId = gid.substring(gid.indexOf('\.')+1);
			
			var coordinate = evt.coordinate;
			//var hdms = toStringHDMS(toLonLat(coordinate));

			content.innerHTML = '<p>图斑信息:</p><code>' + gid +
			  '</code>';
			overlay.setPosition(coordinate);
		
		}
	});
	
})
</script>
</body>
</html>
