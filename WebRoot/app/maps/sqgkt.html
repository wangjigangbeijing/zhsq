
<!-- Content Header (Page header) -->
<section class="content-header">
  <div class="container-fluid">
	<div class="row mb-2">
	  <div class="col-sm-6">
		<h1>社区概况图</h1>
	  </div>
	  <div class="col-sm-6 pull-right">
		<form class="form-horizontal">
		
		<div class='form-group row pull-right' id="layerDiv">
		
		
						<!--div class="form-check">
                          <input class="form-check-input" type="checkbox">
                          <label class="form-check-label">Checkbox</label>
                        </div>
						
						
						<div class="form-check">
                          <input class="form-check-input" type="checkbox">
                          <label class="form-check-label">Checkbox</label>
                        </div-->


		
		
		</form>
		
	  </div>
	</div>
  </div><!-- /.container-fluid -->
</section>

<section class="content">
  <div class="container-fluid">
	<div class="row">
	  <div class="col-md-12">
		<!-- AREA CHART -->
		<div class="card card-primary">
		  <div class="card-header">
			<h3 class="card-title">社区概况图</h3>

			<div class="card-tools">
			  <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
			  </button>
			  <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
			</div>
		  </div>
		 <div class="card-body" id="sqmqtDiv" style="height:700px;">
		  </div>
		  <!-- /.card-body -->
		</div>
		<!-- /.card -->
	  </div>
 
	  <!-- /.col (RIGHT) -->
	</div>
	<!-- /.row -->
  </div><!-- /.container-fluid -->
</section>



<style>
      .map {
        width: 100%;
        height:400px;
      }
      .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "✖";
      }
    </style>
	
	
<div id="map" class="map"></div>

    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>
<!-- ChartJS>
<script src="./plugins/chart.js/Chart.min.js"></script -->

<!-- page script -->
<script>
$(function () 
{
	var container = document.getElementById('popup');
	var content = document.getElementById('popup-content');
	var closer = document.getElementById('popup-closer');

	/**
	 * Add a click handler to hide the popup.
	 * @return {boolean} Don't follow the href.
	 */
	closer.onclick = function() {
	  overlay.setPosition(undefined);
	  closer.blur();
	  return false;
	};


	/**
	 * Create an overlay to anchor the popup to the map.
	 */
	var overlay = new ol.Overlay({
	  element: container,
	  autoPan: true,
	  autoPanAnimation: {
		duration: 250
	  }
	});
	
	var map = new ol.Map({
		overlays: [overlay],
        target: 'sqmqtDiv',
        view: new ol.View({
			//center: ol.proj.transform([116.30454,39.849639], 'EPSG:4326', 'EPSG:3857'),
			center: [116.30446673697033,39.883412379248995],
            zoom: 12,
			//projection: 'EPSG:3857',// 
			projection: 'EPSG:4326',// 
            multiWorld: true
        })/*,
        overlays: [overlay]*/
    });
    
	var baseLayer = new ol.layer.Tile({
        source: new ol.source.TileSuperMapRest({
            //url: "http://219.143.76.46:8089/iserver/services/map-agscache-fengtai/rest/maps/fengtai"
			url: "http://219.143.76.46:8089/iserver/services/map-tianditu/rest/maps/矢量底图_经纬度"
        })
    });
    map.addLayer(baseLayer);
	
	var baseLabelLayer = new ol.layer.Tile({
        source: new ol.source.TileSuperMapRest({
            //url: "http://219.143.76.46:8089/iserver/services/map-agscache-fengtai/rest/maps/fengtai"
			url: "http://219.143.76.46:8089/iserver/services/map-tianditu/rest/maps/矢量中文注记_经纬度"
        })
    });
    map.addLayer(baseLabelLayer);
	
	var dataSource = new ol.source.Vector();								
	dataLayer = new ol.layer.Vector({
		source: dataSource/*,
		style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'red',
                    width: 3
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.1)'
                })
            })*/
	});
	/*
	var iconFeature = new ol.Feature({
		geometry: new ol.geom.Point(ol.proj.transform([116.30454,39.859639], 'EPSG:4326', 'EPSG:3857')),
		weight:1,
		population: 4000,
		rainfall: 500
	});
	dataLayer.getSource().addFeature(iconFeature);	
	
	var iconFeature = new ol.Feature({
		geometry: new ol.geom.Polygon([[ol.proj.transform(["116.30454","39.859639"], 'EPSG:4326', 'EPSG:3857'),
											ol.proj.transform(["116.20654","39.859239"], 'EPSG:4326', 'EPSG:3857'),
											ol.proj.transform(["116.30954","39.559339"], 'EPSG:4326', 'EPSG:3857'),
											ol.proj.transform(["116.30454","39.859639"], 'EPSG:4326', 'EPSG:3857')]]),
		weight:1,
		population: 4000,
		rainfall: 500
	});
	dataLayer.getSource().addFeature(iconFeature);	*/
	map.addLayer(dataLayer);
	
	var layerStyleMap = {};
	
	$.get(getContextPath()+"/gismapController/getMapByName?name=社区概况图",
			function(response)
			{	
				var respObj = jQuery.parseJSON(response); 

				var geoServerURL = respObj.mapurl;
				
				$('#layerDiv').empty();				
				
				for(var i=0;i<respObj.list.length;i++)
				{
					var layer = respObj.list[i];
					
					var layerName = layer.layersource;
					
					var layerId = layer.id;
					
					//图层列表
					var layerCtl = '<div class="form-check">' + 
                          '<input class="form-check-input" type="checkbox" name="layer" id="'+layerId+'" checked>' + 
                          '<label class="form-check-label">'+layer.note+'</label>' + 
                        '</div>';
					
					$('#layerDiv').append(layerCtl);
					
					var layerType = layer.layertype;
					
					var layerStyle = layer.layerstyle;
					
					var layerStyleObj = jQuery.parseJSON(layerStyle); 
					
					layerStyleMap[layerId] = layerStyleObj;
					
					$.ajax({
						type: "GET",
						//url:"http://49.233.26.198:8082/gis/zhsq/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=zhsq:jc_community&maxFeatures=50&outputFormat=application/json",
						url: getContextPath()+"/dataController/webwfs?layerId="+layerId,
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function (dataList) {
							
							for(var p=0;dataList.features != null && p < dataList.features.length;p++)
							{
								var data = dataList.features[p];
								
								console.log(data.type);
								if(data.type == 'MultiLineString')
								{
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.MultiLineString(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'Point')
								{
									/*var iconFeature = new ol.Feature({
										geometry: new ol.geom.Point(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									dataLayer.getSource().addFeature(iconFeature);	
									*/
									
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.Point(data.coordinates)/*,			
										weight:1,
										population: 4000,
										rainfall: 500*/
									});
									
									iconFeature.setStyle(new ol.style.Style({
										image: new ol.style.Icon({
											src: getContextPath()+"fileController/downloadIcon?fileName="+layerStyleObj.style.iconurl//'../icons/point.png'
										})
									}));
									
									iconFeature.setId(data.id);
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'MultiPolygon')
								{
									var pointArr = data.coordinates;
									
									/*var transferedArr = [];//data.coordinates;
									
									for(var q=0;q<pointArr.length;q++)
									{
										transferedArr[q] = ol.proj.transform(pointArr[q], 'EPSG:4326', 'EPSG:3857');
									}*/
									
									//https://www.cnblogs.com/lishanyang/p/6071528.html
									
									
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.Polygon(data.coordinates)/*,
										weight:1,
										population: 4000,
										rainfall: 500*/
									});
									iconFeature.setId(data.info);
									
									iconFeature.setStyle(new ol.style.Style({
										stroke: new ol.style.Stroke({       // 线样式
											color: layerStyleObj.style['stroke-color'],//'blue',
											width: layerStyleObj.style['stroke-width']
										}),
										fill: new ol.style.Fill({           // 填充样式
											color: layerStyleObj.style['fill-color'],//'orange'
											opacity: layerStyleObj.style['fill-opacity']
										})
									}));
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
							}
						}
					});
				}
				
				
				$("input[name='layer']").change(function() {
					
					var checkedLayerId = '';
					
					$("input[name='layer']").each(function () {
						
						if($(this).prop('checked'))
							checkedLayerId += $(this).attr('id')+',';
					});
					
					
					$.ajax({
						type: "GET",
						//url:"http://49.233.26.198:8082/gis/zhsq/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=zhsq:jc_community&maxFeatures=50&outputFormat=application/json",
						url: getContextPath()+"/dataController/wfs?layerIds="+checkedLayerId,
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function (dataList) {
							
							dataLayer.getSource().clear();
							
							for(var p=0;dataList.features != null && p < dataList.features.length;p++)
							{
								var data = dataList.features[p];
							
								layerStyleObj = layerStyleMap[data.layerId];
							
								if(data.type == 'MultiLineString')
								{
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.MultiLineString(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'Point')
								{
									/*var iconFeature = new ol.Feature({
										geometry: new ol.geom.Point(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setId(data.id);
									dataLayer.getSource().addFeature(iconFeature);	
									*/
									
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.Point(data.coordinates),			
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setStyle(new ol.style.Style({
										image: new ol.style.Icon({
											src: getContextPath()+"fileController/downloadIcon?fileName="+layerStyleObj.style.iconurl//'../icons/point.png'
										})
									}));
									
									iconFeature.setId(data.id);
									dataLayer.getSource().addFeature(iconFeature);	
								}
								else if(data.type == 'MultiPolygon')
								{
									var pointArr = data.coordinates;
									
									var iconFeature = new ol.Feature({
										geometry: new ol.geom.Polygon(data.coordinates),
										weight:1,
										population: 4000,
										rainfall: 500
									});
									
									iconFeature.setStyle(new ol.style.Style({
										stroke: new ol.style.Stroke({       // 线样式
											color: layerStyleObj.style['stroke-color'],//'blue',
											width: layerStyleObj.style['stroke-width']
										}),
										fill: new ol.style.Fill({           // 填充样式
											color: layerStyleObj.style['fill-color'],//'orange'
											opacity: layerStyleObj.style['fill-opacity']
										})
									}));
									
									iconFeature.setId(data.info);
									
									dataLayer.getSource().addFeature(iconFeature);	
								}
							}
						}
					});
					
				});
			}
	);
	
	map.on('singleclick', function(evt) 
	{
		var feature = map.forEachFeatureAtPixel(evt.pixel,
			function(feature) {
			
				return feature;
		});
		
		if(feature != null && feature != undefined)
		{
			var gid = feature.getId();
			
			//curId = gid.substring(gid.indexOf('\.')+1);
			
			var coordinate = evt.coordinate;
			//var hdms = toStringHDMS(toLonLat(coordinate));

			content.innerHTML = '<p>图斑信息:</p><code>' + gid +
			  '</code>';
			overlay.setPosition(coordinate);
		
		}
	});
	
})


</script>
